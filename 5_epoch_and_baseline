"""
STEP 5 — Epoching + baseline (hand-mixed)
Paper:
  epochs: -0.200 to +0.700 s
  baseline: -0.110 to -0.010 s
"""

from pathlib import Path
import mne

BASE = Path(r"C:\Users\navar\Desktop\ds004388-1.0.0")

# Ahora viene del Step 4 (ya ICA + reref + thresholds)
IN_DIR  = BASE / "eeg_step4_condition_cleaned"
OUT_DIR = BASE / "eeg_step6_epochs"
OUT_DIR.mkdir(exist_ok=True, parents=True)

CONDITION = "hand-mixed"

def pick_stim_events_from_annotations(raw):
    events, event_id = mne.events_from_annotations(raw)
    if len(events) == 0:
        raise RuntimeError("No events found in annotations. ¿Tus triggers están en un canal STI?")
    return events, event_id

def step6_epoch(subjects=range(1, 50)):
    for s in subjects:
        subj = f"sub-{s:03d}"

        fif_path = IN_DIR / subj / f"{CONDITION}_clean.fif"
        if not fif_path.exists():
            print(f"⚠ {subj}: no file {fif_path.name} — skipping.")
            continue

        print(f"\n===== {subj}, {CONDITION} — EPOCHING =====")
        raw = mne.io.read_raw_fif(fif_path, preload=True, verbose="warning")

        # Events
        events, event_id = pick_stim_events_from_annotations(raw)

        # Epochs
        epochs = mne.Epochs(
            raw,
            events,
            event_id=event_id,          # si quieres uno específico, aquí se filtra
            tmin=-0.2,
            tmax=0.7,
            baseline=(-0.11, -0.01),
            reject_by_annotation=True,
            preload=True,
            verbose="warning",
        )

        out_subdir = OUT_DIR / subj
        out_subdir.mkdir(exist_ok=True, parents=True)
        out_path = out_subdir / f"{CONDITION}_epo.fif"
        epochs.save(out_path, overwrite=True)
        print("✔ Saved:", out_path)

if __name__ == "__main__":
    step6_epoch(subjects=range(1, 50))

